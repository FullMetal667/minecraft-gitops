# -------- Stage 1: build mcrcon --------
FROM debian:stable-slim AS mcrcon-builder

RUN apt-get update \
 && apt-get install -y --no-install-recommends ca-certificates git build-essential \
 && update-ca-certificates

WORKDIR /src
RUN git clone --depth 1 https://github.com/Tiiffi/mcrcon.git
WORKDIR /src/mcrcon
RUN make

# -------- Stage 2: runtime image --------
FROM registry.access.redhat.com/ubi9/openjdk-21:latest
SHELL ["/bin/bash","-o","pipefail","-c"]

# KEIN fixed USER -> OpenShift nutzt arbitrary UID
# USER 0 NICHT setzen, sonst brauchst du anyuid

LABEL org.opencontainers.image.source="https://github.com/FullMetal667/minecraft-gitops" \
      org.opencontainers.image.title="ATM10 Minecraft Server" \
      org.opencontainers.image.version="0.1.0" \
      org.opencontainers.image.vendor="chrisroth667" \
      org.opencontainers.image.licenses="MIT"

# minimal benötigte Tools
RUN microdnf install -y curl-minimal unzip nmap-ncat which ca-certificates --setopt=install_weak_deps=0 \
 && microdnf clean all \
 && update-ca-trust

# tini reinholen (wie bei aof7)
ENV TINI_VERSION=v0.19.0
ADD https://github.com/krallin/tini/releases/download/${TINI_VERSION}/tini-amd64 /usr/local/bin/tini
RUN chmod +x /usr/local/bin/tini && ln -s /usr/local/bin/tini /usr/bin/tini

# mcrcon aus Stage 1
COPY --from=mcrcon-builder --chmod=0755 --chown=0:0 /src/mcrcon/mcrcon /usr/local/bin/mcrcon

# launch-Skript
COPY atm10/startserver.sh /opt/startserver.sh

# Verzeichnisse
ENV APP_DIR=/opt/atm10 \
    DATA_DIR=/data

RUN mkdir -p "${APP_DIR}" "${DATA_DIR}"

# Optionaler Modpack-Download zur Buildzeit (wie bei aof7)
ARG FILE_ID
ARG ZIP
ARG DIR
RUN if [[ -n "${FILE_ID}" && -n "${ZIP}" && -n "${DIR}" ]]; then \
      DIR1=$(( FILE_ID / 1000 )); \
      DIR2=$(( FILE_ID % 1000 )); \
      FINAL_URL="https://mediafilez.forgecdn.net/files/${DIR1}/${DIR2}/${ZIP}"; \
      echo "Downloading: ${FINAL_URL}"; \
      curl -fL -o "${APP_DIR}/${ZIP}" "${FINAL_URL}"; \
      unzip -uo "${APP_DIR}/${ZIP}" -d "${DATA_DIR}"; \
    else \
      echo "FILE_ID/ZIP/DIR nicht gesetzt – skip download"; \
    fi

# OpenShift-kompatible Rechte (arbitrary UID, Gruppe 0, group-writable)
RUN chgrp -R 0 "${APP_DIR}" "${DATA_DIR}" /opt/launch.sh /usr/local/bin/mcrcon \
 && chmod -R g=u "${APP_DIR}" "${DATA_DIR}" \
 && chmod g=u /opt/startserver.sh /usr/local/bin/mcrcon \
 && find "${APP_DIR}" -type d -exec chmod g+s {} \; \
 && find "${DATA_DIR}" -type d -exec chmod g+s {} \;

WORKDIR ${DATA_DIR}
VOLUME ["/data"]
EXPOSE 25565/tcp
# EXPOSE 25575/tcp  # falls du RCON exposen willst

ENTRYPOINT ["/usr/local/bin/tini","--"]
CMD ["/opt/startserver.sh"]
